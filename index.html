<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CallCode — Salesforce #call calculator</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --glass: rgba(255,255,255,0.03);
  --amBg: rgba(255,255,255,0.045);
  --pmBg: rgba(56,189,248,0.10);
  --nextRing: rgba(56,189,248,.45);
  --nextPillBg: rgba(56,189,248,.18);
  --nextPillBorder: rgba(56,189,248,.55);
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:#e6eef8;min-height:100vh;
  display:flex;align-items:center;justify-content:center;
  padding:24px;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;
}
.wrap{
  width:100%;max-width:1350px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.7);position:relative;
}

/* Tool toggle group */
#tsToggleWrap{
  position:absolute;top:14px;right:14px;text-align:right;
}
.tool-toggle{display:flex;gap:8px;justify-content:flex-end}
.tool-btn{
  padding:8px 10px;font-size:13px;border-radius:8px;transition:all .2s ease;cursor:pointer;
  background:transparent;color:var(--accent);border:1px solid rgba(56,189,248,0.35);
}
.tool-btn:hover{border-color:rgba(56,189,248,0.55);box-shadow:0 0 0 3px rgba(56,189,248,0.18) inset;}
.tool-btn[aria-pressed="true"]{
  background:linear-gradient(90deg,var(--accent),#60a5fa);
  color:#021124;border:0;filter:saturate(1.05);
}
.tool-btn[aria-pressed="true"]:hover{filter:saturate(1.15);}
.tool-btn:focus-visible{outline:2px solid #60a5fa;outline-offset:2px}

/* Header / layout */
header{text-align:center;margin-bottom:20px}
.logo-container{
  display:inline-block;padding:12px;background:var(--card);border-radius:12px;margin-bottom:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
header img{max-width:180px;border-radius:8px}
h1{margin:0;font-size:24px;color:var(--accent)}
p.lead{margin:6px 0 18px;color:var(--muted);font-size:13px}

.grid{
  display:grid;grid-template-columns:1fr 1fr;gap:24px;
  transition:all .4s ease;
}
.card{
  background:var(--card);border-radius:12px;padding:16px;
  display:flex;flex-direction:column;gap:12px;min-height:220px;
}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
select,input[type=time],input[type=date],input[type=number]{
  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);
  background:rgba(255,255,255,0.06);color:#e6eef8;
}
select option{background:var(--card);color:#e6eef8}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;border:0;
  background:linear-gradient(90deg,var(--accent),#60a5fa);color:#021124;font-weight:600;cursor:pointer;
}
.btn.alt{background:transparent;color:var(--accent);border:1px solid rgba(56,189,248,0.12)}
.output{
  font-family:monospace;background:rgba(0,0,0,0.12);padding:10px;border-radius:8px;width:100%;
  font-size:16px;word-wrap:break-word;min-height:48px;
}
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:rgba(56,189,248,0.15);color:var(--accent);
  padding:10px 16px;border-radius:8px;font-size:14px;opacity:0;pointer-events:none;
  transition:opacity .4s ease;
}
.toast.show{opacity:1}
footer{text-align:center;margin-top:14px;color:var(--muted);font-size:13px}

/* Shared tool panel */
.toolpanel{
  background:var(--card);border-radius:12px;padding:16px;
  opacity:0;transform:scale(0.96);transition:all .35s ease;
}
.toolpanel.visible{opacity:1;transform:scale(1)}
.toolpanel h3{margin:0 0 8px 0;color:var(--accent);font-size:16px}

/* Legend */
.ts-legend{
  display:flex;gap:14px;align-items:center;justify-content:flex-end;
  color:var(--muted);font-size:12px;margin-bottom:8px
}
.ts-chip{width:12px;height:12px;border-radius:3px;display:inline-block}
.ts-chip.am{background:var(--amBg)}
.ts-chip.pm{background:var(--pmBg)}

/* TimeSync rows */
.ts-row{margin-bottom:14px}
.ts-label{
  font-size:13px;color:#dbe7ff;margin-bottom:6px;display:flex;align-items:center;gap:8px
}
.ts-now{font-size:12px;color:var(--muted)}
.ts-grid{position:relative;overflow:hidden;height:34px;}
.ts-cells{
  display:grid;grid-template-columns:repeat(24, 1fr);
  column-gap:6px;
}
.ts-cell{
  background:var(--amBg);
  border-radius:6px;height:34px;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;color:#e6eef8;position:relative;user-select:none;
}
.ts-cell.pm{background:var(--pmBg)}
.ts-cell.next{box-shadow:inset 0 0 0 1px var(--nextRing)}
.ts-cell.next .ts-pill{
  position:absolute;top:-18px;left:50%;transform:translateX(-50%);
  background:var(--nextPillBg);border:1px solid var(--nextPillBorder);
  color:#cfeeff;border-radius:6px;padding:1px 6px;font-size:10px;white-space:nowrap
}
.ts-cell:hover{outline:1px solid rgba(96,165,250,.45);cursor:pointer}

.ts-indicator{
  position:absolute;top:-4px;bottom:-4px;left:0;
  background:rgba(56,189,248,0.18);
  border:1px solid rgba(56,189,248,0.7);
  border-radius:8px;pointer-events:none;
  transform:translateX(0);
  transition:transform .06s linear,width .06s linear;
}

/* Planner placeholder */
.planner-note{
  color:var(--muted);font-size:14px;line-height:1.45;
  background:rgba(255,255,255,0.04);border-radius:8px;padding:12px
}

/* Responsive */
@media(max-width:980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap" id="appWrap">

  <!-- Tool toggle block (legend removed) -->
  <div id="tsToggleWrap">
    <div class="tool-toggle" id="toolToggle">
      <button class="tool-btn" data-tool="timesync" aria-pressed="false">TimeSync</button>
      <button class="tool-btn" data-tool="planner"  aria-pressed="false">Planner</button>
    </div>
  </div>

  <header>
    <div class="logo-container"><img src="CallCodeLogo.png" alt="CallCode Logo"></div>
    <h1>CallCode</h1>
    <p class="lead">Generate <code>#call &lt;minutes&gt;</code> for Salesforce quickly</p>
  </header>

  <div class="grid" id="gridLayout">
    <!-- Calculator -->
    <div class="card">
      <label for="baseZone">Base timezone</label>
      <select id="baseZone">
        <option value="America/Los_Angeles" selected>PST — America/Los_Angeles</option>
        <option value="America/Chicago">CST — America/Chicago</option>
        <option value="America/New_York">EST — America/New_York</option>
        <option value="America/Argentina/Buenos_Aires">ART — America/Argentina/Buenos_Aires</option>
        <option value="UTC">UTC</option>
        <option value="Europe/London">Europe/London</option>
      </select>

      <label for="targetTime">Target time</label>
      <input id="targetTime" type="time" class="styled-time" />

      <label for="targetDate">Target date</label>
      <input id="targetDate" type="date">

      <label>Quick add days</label>
      <input id="quickDays" type="number" min="0" placeholder="e.g. 7">

      <div class="row">
        <button id="resetBtn" class="btn alt">Reset</button>
        <button id="copyBtn" class="btn alt">Copy</button>
      </div>
    </div>

    <div class="card">
      <label>Converted Salesforce comment</label>
      <div class="output" id="generated">#call —</div>
    </div>

    <!-- Shared tool panel -->
    <div class="toolpanel" id="toolPanel" style="display:none">
      <!-- Tool: TimeSync -->
      <div id="tool-timesync" class="tool-view" style="display:none">
        <h3>TimeSync</h3>
        <div class="ts-legend">
          <span class="ts-chip am"></span> AM
          <span class="ts-chip pm"></span> PM
        </div>

        <div class="ts-row" data-zone="America/Los_Angeles">
          <div class="ts-label">
            <strong>PST</strong><span class="ts-now" id="now-pst">—</span>
          </div>
          <div class="ts-grid" id="grid-pst">
            <div class="ts-indicator" id="ind-pst"></div>
            <div class="ts-cells"></div>
          </div>
        </div>

        <div class="ts-row" data-zone="America/Chicago">
          <div class="ts-label">
            <strong>CST</strong><span class="ts-now" id="now-cst">—</span>
          </div>
          <div class="ts-grid" id="grid-cst">
            <div class="ts-indicator" id="ind-cst"></div>
            <div class="ts-cells"></div>
          </div>
        </div>

        <div class="ts-row" data-zone="America/New_York">
          <div class="ts-label">
            <strong>EST</strong><span class="ts-now" id="now-est">—</span>
          </div>
          <div class="ts-grid" id="grid-est">
            <div class="ts-indicator" id="ind-est"></div>
            <div class="ts-cells"></div>
          </div>
        </div>
      </div>

      <!-- Tool: Planner (placeholder) -->
      <div id="tool-planner" class="tool-view" style="display:none">
        <h3>Planner</h3>
        <div class="planner-note">
          If you have any ideas for useful tools that can be integrated or things you would like to see, reach out in Teams/DS and let me know, and we can add them here.
        </div>
      </div>
    </div>
  </div>

  <footer><button class="btn" onclick="downloadHTML()">Download HTML</button></footer>
</div>

<div id="toast" class="toast"></div>

<script>
const { DateTime } = luxon;

/* ---------------- Calculator ---------------- */
let originalDT=null;
function showToast(m){
  const t=document.getElementById('toast');
  t.textContent=m;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1500);
}
function generateComment(){
  const baseZone=document.getElementById('baseZone').value;
  const time=document.getElementById('targetTime').value;
  const date=document.getElementById('targetDate').value;
  if(!date||!time){
    document.getElementById('generated').innerText="Select date and time first.";return;
  }
  let [hour,minute]=time.split(':').map(n=>parseInt(n,10));
  const inputDT=DateTime.fromObject(
    {year:+date.split('-')[0],month:+date.split('-')[1],day:+date.split('-')[2],hour,minute},
    {zone:baseZone}
  );
  const now=DateTime.now().setZone(baseZone);
  const diffMinutes=Math.round(inputDT.diff(now,'minutes').minutes);
  const formatted=inputDT.toFormat("MMM dd, yyyy hh:mm a");
  const output=diffMinutes>0?`#call ${diffMinutes}\n(${formatted} ${baseZone})`:"Selected time is in the past.";
  document.getElementById('generated').innerText=output;
  if(diffMinutes>0){
    const onlyCall=`#call ${diffMinutes}`;
    navigator.clipboard?.writeText(onlyCall).then(()=>showToast(`Copied ${onlyCall}`));
  }
}
['targetTime','baseZone','targetDate'].forEach(id=>{
  document.getElementById(id).addEventListener('change',()=>{originalDT=null;generateComment();});
});
document.getElementById('quickDays').addEventListener('input',()=>{
  const days=parseInt(document.getElementById('quickDays').value,10);
  if(isNaN(days))return;
  const baseZone=document.getElementById('baseZone').value;
  if(!originalDT){
    const time=document.getElementById('targetTime').value;
    if(!time)return;
    let [hour,minute]=time.split(':').map(n=>parseInt(n,10));
    const date=document.getElementById('targetDate').value;
    if(!date)return;
    originalDT=DateTime.fromObject(
      {year:+date.split('-')[0],month:+date.split('-')[1],day:+date.split('-')[2],hour,minute},
      {zone:baseZone}
    );
  }
  const newDT=originalDT.plus({days});
  document.getElementById('targetDate').value=newDT.toISODate();
  generateComment();
});
document.getElementById('copyBtn').addEventListener('click',()=>{
  const m=document.getElementById('generated').innerText.match(/#call \d+/);
  if(m)navigator.clipboard.writeText(m[0]).then(()=>showToast("Copied!"));
});
document.getElementById('resetBtn').addEventListener('click',()=>{
  document.getElementById('targetDate').value='';
  document.getElementById('targetTime').value='';
  document.getElementById('quickDays').value='';
  document.getElementById('generated').innerText='#call —';
});
window.addEventListener('DOMContentLoaded',()=>{
  const now=DateTime.now().setZone('America/Los_Angeles');
  document.getElementById('targetDate').value=now.toISODate();
  document.getElementById('targetTime').value=now.toFormat("HH:mm"); // 24h input (current checkpoint)
  generateComment();
});

/* ---------------- TimeSync (fixed cells; numbers shift) ---------------- */
const TS_ZONES = [
  { id:'pst', label:'PST', zone:'America/Los_Angeles' },
  { id:'cst', label:'CST', zone:'America/Chicago' },
  { id:'est', label:'EST', zone:'America/New_York' },
];
let tsHour = DateTime.now().setZone('America/Los_Angeles').hour;

function baseMidnightPST(){
  return DateTime.now().setZone('America/Los_Angeles').startOf('day');
}
function cellLabel(h){ return ((h+11)%12)+1; } // 0->12, 13->1

function buildFixedRow(gridEl, clickable=false){
  const wrap = gridEl.querySelector('.ts-cells');
  wrap.innerHTML='';
  for(let j=0;j<24;j++){
    const div=document.createElement('div');
    div.className='ts-cell';
    div.innerHTML='<span>–</span>';
    if(clickable){
      div.addEventListener('click', ()=> { setSliderHour(j); });
    }
    wrap.appendChild(div);
  }
}

function renderTimeSync(){
  const base0 = baseMidnightPST(); // 00:00 in PST today

  TS_ZONES.forEach(({id, zone})=>{
    const grid = document.getElementById(`grid-${id}`);
    const wrap = grid.querySelector('.ts-cells');
    wrap.querySelectorAll('.ts-pill').forEach(p=>p.remove());

    const refLocalDay = base0.setZone(zone).startOf('day');
    let nextDayMarked = false;

    for(let j=0;j<24;j++){
      const pstColInstant = base0.plus({hours:j});
      const local = pstColInstant.setZone(zone);

      const cell = wrap.children[j];
      const num = cell.querySelector('span');

      cell.classList.remove('am','pm','next');
      cell.classList.add(local.hour<12 ? 'am' : 'pm');

      num.textContent = cellLabel(local.hour);

      if (local.startOf('day') > refLocalDay){
        cell.classList.add('next');
        if(!nextDayMarked){
          const pill=document.createElement('div');
          pill.className='ts-pill';
          pill.textContent = `${local.toFormat('ccc')} • ${local.toFormat('LLL d')}`;
          cell.appendChild(pill);
          nextDayMarked = true;
        }
      }
    }
  });

  updateNowBadges();
  positionIndicators();
}

function updateNowBadges(){
  const baseInstant = baseMidnightPST().plus({hours:tsHour});
  TS_ZONES.forEach(({id, zone})=>{
    const nowEl = document.getElementById(`now-${id}`);
    const local = baseInstant.setZone(zone);
    nowEl.textContent = `• ${local.toFormat("ccc, LLL d — h:mm a")}`;
  });
}

function positionIndicators(){
  const pstGrid = document.getElementById('grid-pst');
  const wrap    = pstGrid.querySelector('.ts-cells');
  const cells   = wrap.querySelectorAll('.ts-cell');
  const cell    = cells[tsHour];
  if(!cell) return;
  const left  = cell.offsetLeft;
  const width = cell.offsetWidth;

  TS_ZONES.forEach(({id})=>{
    const ind = document.getElementById(`ind-${id}`);
    ind.style.width = `${width}px`;
    ind.style.transform = `translateX(${left}px)`;
  });
}

function setSliderHour(h){
  tsHour = Math.max(0, Math.min(23, h));
  updateNowBadges();
  positionIndicators();
}

function attachDrag(grid){
  let dragging = false;
  const wrap = grid.querySelector('.ts-cells');

  function hourFromClientX(clientX){
    const rect = grid.getBoundingClientRect();
    const relX = Math.min(Math.max(clientX - rect.left, 0), rect.width);
    let bestIndex = 0, bestDist = Infinity;
    wrap.querySelectorAll('.ts-cell').forEach((c,i)=>{
      const center = c.offsetLeft + c.offsetWidth/2;
      const d = Math.abs(relX - center);
      if(d < bestDist){ bestDist = d; bestIndex = i; }
    });
    return bestIndex;
  }

  grid.addEventListener('mousedown',(e)=>{
    dragging = true;
    setSliderHour(hourFromClientX(e.clientX));
  });
  window.addEventListener('mousemove',(e)=>{
    if(!dragging) return;
    setSliderHour(hourFromClientX(e.clientX));
  });
  window.addEventListener('mouseup',()=> dragging=false);

  grid.tabIndex = 0;
  grid.addEventListener('keydown',(e)=>{
    if(e.key==='ArrowLeft')  setSliderHour(tsHour-1);
    if(e.key==='ArrowRight') setSliderHour(tsHour+1);
  });
}

function buildTimeSync(){
  buildFixedRow(document.getElementById('grid-pst'), true);
  buildFixedRow(document.getElementById('grid-cst'), true);
  buildFixedRow(document.getElementById('grid-est'), true);

  renderTimeSync();
  attachDrag(document.getElementById('grid-pst'));
  attachDrag(document.getElementById('grid-cst'));
  attachDrag(document.getElementById('grid-est'));
}

window.addEventListener('resize', positionIndicators);

/* ---------------- Tool panel management ---------------- */
const gridLayout = document.getElementById('gridLayout');
const toolPanel  = document.getElementById('toolPanel');

function showTool(key){
  document.querySelectorAll('.tool-view').forEach(v=>{
    v.style.display = (v.id === `tool-${key}`) ? 'block' : 'none';
  });
  document.querySelectorAll('.tool-btn').forEach(b=>{
    b.setAttribute('aria-pressed', b.dataset.tool===key ? 'true':'false');
  });
  localStorage.setItem('activeTool', key);

  if (key==='timesync' && !toolPanel.dataset.tsBuilt){
    buildTimeSync();
    toolPanel.dataset.tsBuilt = '1';
  }
  if (key==='timesync'){
    positionIndicators();
  }
}

function applyTools(visible){
  toolPanel.style.display = visible ? 'block' : 'none';
  setTimeout(()=>{ toolPanel.classList.toggle('visible', visible); }, 10);
  gridLayout.style.gridTemplateColumns = visible ? '1fr 1fr 700px' : '1fr 1fr';
  localStorage.setItem('toolsVisible', visible ? 'true':'false');
  if(visible){
    const key = localStorage.getItem('activeTool') || 'timesync';
    showTool(key);
  }
}

// Toggle logic for tool buttons
document.querySelectorAll('.tool-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const key = btn.dataset.tool;
    const visible = toolPanel.style.display !== 'none';
    const current = localStorage.getItem('activeTool') || 'timesync';

    if(!visible){ // open with this tool
      localStorage.setItem('activeTool', key);
      applyTools(true);
    }else if(current !== key){ // switch tool
      showTool(key);
    }else{ // same tool → close
      applyTools(false);
    }
  });
});

// Restore state
const savedVisible = localStorage.getItem('toolsVisible')==='true';
applyTools(savedVisible);

/* ---------------- DST/Date auto-refresh watcher (TimeSync) ---------------- */
let lastDateKeyPST = DateTime.now().setZone('America/Los_Angeles').toISODate();
let lastOffsetPST  = DateTime.now().setZone('America/Los_Angeles').offset;
setInterval(() => {
  const nowPST = DateTime.now().setZone('America/Los_Angeles');
  const dateKey = nowPST.toISODate();
  const offset  = nowPST.offset;

  if (dateKey !== lastDateKeyPST || offset !== lastOffsetPST) {
    lastDateKeyPST = dateKey;
    lastOffsetPST  = offset;

    const active = localStorage.getItem('activeTool') || 'timesync';
    if (toolPanel.style.display !== 'none' && active==='timesync' && toolPanel.dataset.tsBuilt) {
      renderTimeSync();
      positionIndicators();
    }
  }
}, 60 * 1000);

/* ---------------- Download ---------------- */
function downloadHTML(){
  const a=document.createElement('a');
  const file=new Blob([document.documentElement.outerHTML],{type:'text/html'});
  a.href=URL.createObjectURL(file);
  a.download='CallCode.html';
  document.body.appendChild(a); a.click(); a.remove();
}
</script>
</body>
</html>
